<!DOCType HTML>
<html>
<head>
<title>Testing JavaScript</title>
</head>
<body>
<script type="text/javascript">
	var key = "d09ad1beb3b885847a39492a0f66987d";
	var url = "https://api.legiscan.com/?key=" + key + "&op=";
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url + "getMasterList&id=1400", false);
	xhr.send();
	var test= JSON.parse(xhr.responseText);

	function getDictionary (jsession)
	{
		var dicty= {};
		
		for (var key in jsession.masterlist)
		{	
			if (isNaN(key))
			{
				continue; //skips over non-number at end
			}
			var id = jsession.masterlist[key].bill_id;
			var number = jsession.masterlist[key].number;
			dicty[number] = id;
			
			//document.write( number+ " : " + dicty[number] + "<br>");
		
		}
		return dicty

	}
	function getSortedBills(jsession)
	{
		var times= {};
		var ids = [];
		for (var key in jsession.masterlist)
		{	
			
			if (isNaN(key))
			{
				continue; //skips over non-number at end
			}
			var id = jsession.masterlist[key].bill_id;
			
			var date = new Date(jsession.masterlist[key].last_action_date);
			
			dateInMs = date.getTime();
			times[id] = dateInMs;
			ids.push(id);
			
			//document.write( id+ " : " + times[id] + "<br>");
		
		}
		
		ids.sort(function(a, b){return times[b]-times[a]}); //a-b ascending b-a ascending
		return ids;

	}
	function getDocNumber(billNumber)
	{
	    
	    var test= getBill(billNumber);
	    var docNumber= test.bill.texts[test.bill.texts.length-1].doc_id; //test.bill.texts is an array so gets current version (last item in x)
	    
	    return docNumber;
	}
	function upcoming(target = 10)
	{	
		var count = 0;
		function isUpcoming(billID)
		{
			
			info= getBill(billID);
			if (info.bill.status <=3)
			{
				return true;
			}
			return false;
			
		}
		
        var sortedBills = getSortedBills(test);
		
        var output= [];
		
		for (var item in sortedBills)
		{
			
			if (isUpcoming(sortedBills[item]))
			{
				count++
				
				jbill = getBill(sortedBills[item]);
				var toadd = {};
				var hislength = jbill.bill.history.length;
				toadd["id"] = sortedBills[item]; //from above
				toadd["date"] = jbill.bill.history[hislength-1].date;
				toadd["description"] = jbill.bill.description;
				toadd["action"] = jbill.bill.history[hislength-1].action;
				toadd["number"] = jbill.bill.bill_number;
				toadd["title"] = jbill.bill.title;
				output.push(toadd);
				
			}
			if (count >= target)
			{
				break;
			}
		
		}
		
		
	    return output;
	}
	function getBill(billNumber)
	{
		
		var req = new XMLHttpRequest();
		req.open("GET", url + "getBill&id=" + billNumber, false);
		req.send();
		return JSON.parse(req.responseText);
	}
	//console.log(getBill(892574));
	console.log(upcoming(20));
	
	

</script>
</body>
</html>