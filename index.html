<!DOCTYPE html>

<html>
  <head>
    <title>CalVote</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- cdn for modernizr, if you haven't included it already -->
    <script src="http://cdn.jsdelivr.net/webshim/1.12.4/extras/modernizr-custom.js"></script>
    <!-- polyfiller file to detect and load polyfills -->
    <script src="http://cdn.jsdelivr.net/webshim/1.12.4/polyfiller.js"></script>
    <script>
      webshims.setOptions('waitReady', false);
      webshims.setOptions('forms-ext', {types: 'date'});
      webshims.polyfill('forms forms-ext');
    </script>
  </head>



	<body>
		<!-- Main Screen -->
    <div id="firstBox">
			<form id="centerBox" class="fade-in" action="javascript:void(0);">
				<!-- hidden button -->
        <input type="submit" class="defaultsink" onclick="search()" />
        <h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
        <input type="submit" value="Upcoming" onclick="upcoming()" />
        <h3>- OR -</h3>

        <label for="bill">Bill Number <span style="color:#a8a8a8;">(SB#, AB#, ACR#, etc...)</span></label>
				<input type="text" id="bill" name="firstname" placeholder="Number...">

        <label for="day">Date of Last Action</label><br>
				<input type="date" id="day" name="day" min="1970-01-01" required ><br>

				<input type="submit" value="Search" onclick="search()" tabindex="0">
			</form>
		</div>
		

    <!-- Blank Box -->
		<div id="secondBox">
			<h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
			<div id="text">
			</div>
		</div>


		<!-- List Box -->
		<div id="thirdBox">
			<h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
			<div id="list">
			</div>
		</div>
		

    <input type="submit" id="back" value="Back" onclick="backToMain()" disabled/>
	</body>
	

	<script>
    // Dictionary
    var key = "d09ad1beb3b885847a39492a0f66987d";
    var url = "https://api.legiscan.com/?key=" + key + "&op=";

		var xhr = new XMLHttpRequest();
		xhr.open("GET", url + "getMasterList&id=1400", false);
		xhr.send();
		var test= JSON.parse(xhr.responseText);

		function getDictionary (jsession)
		{
			var dicty= {};
			var ids = [];
			for (var key in jsession.masterlist)
			{	
				if (isNaN(key))
				{
					continue; //skips over non-number at end
				}
				var id = jsession.masterlist[key].bill_id;
				var number = jsession.masterlist[key].number;
				dicty[number] = id;
				ids.push[id];
				//document.write( number+ " : " + dicty[number] + "<br>");
	
			}
			return dicty
		}
		
		var dictionary = getDictionary(test);
		
		function getSortedBills(jsession)
	{
		var times= {};
		var ids = [];
		for (var key in jsession.masterlist)
		{	
			
			if (isNaN(key))
			{
				continue; //skips over non-number at end
			}
			var id = jsession.masterlist[key].bill_id;
			
			var date = new Date(jsession.masterlist[key].last_action_date);
			
			dateInMs = date.getTime();
			times[id] = dateInMs;
			ids.push(id);
			
			//document.write( id+ " : " + times[id] + "<br>");
		
		}
		
		ids.sort(function(a, b){return times[b]-times[a]}); //a-b ascending b-a ascending
		return ids;

	}
	
	function getDocNumber(billNumber)
	{
	    
	    var test= getBill(billNumber);
	    var docNumber= test.bill.texts[test.bill.texts.length-1].doc_id; //test.bill.texts is an array so gets current version (last item in x)
	    return docNumber;
	}
	
	function getUpcoming(target = 10)
	{	
		var count = 0;
		function isUpcoming(billID)
		{
			
			info= getBill(billID);
			if (info.bill.status <=3)
			{
				return true;
			}
			return false;
			
		}
		
        var sortedBills = getSortedBills(test);
		
        var output= [];
		
		for (var item in sortedBills)
		{
			sortedBills[sortedBills[item]]
			if (isUpcoming(sortedBills[item]))
			{
				count++
				//upcomingList.push(sortedBills[item]);
				jbill = getBill(sortedBills[item]);
				var toadd = {};
				toadd["id"] = sortedBills[item]; //from above
				toadd["date"] = jbill.bill.history[history.length-1].date;
				toadd["description"] = jbill.bill.description;
				toadd["action"] = jbill.bill.history[history.length-1].action;
				toadd["number"] = jbill.bill.bill_number;
				toadd["title"] = jbill.bill.title;
				output.push(toadd);
			}
			if (count >= target)
			{
				break;
			}
		
		}
		
		
	    return output;
	}
	function getBill(billNumber)
	{
		
		var req = new XMLHttpRequest();
		req.open("GET", url + "getBill&id=" + billNumber, false);
		req.send();
		return JSON.parse(req.responseText);
	}
	
		//1439185
		
		function fillBillInfo(x) {
			var xhr = new XMLHttpRequest();
			xhr.open("GET", url + "getBillText&id="+getDocNumber(x), false);
			xhr.send();
			testyj = JSON.parse(xhr.responseText);
			document.getElementById("text").innerHTML = atob(testyj.text.doc);
		}
	
	
	//
		var current =  document.getElementById("firstBox");
		
		function upcoming() {
			transitionOut(current);
			fillUpcoming(10);
			presentList();
		}
	
		function search() {
			var billNum = document.getElementById("bill").value;
			var day;
			if (document.getElementById("day") != null) {
				day = document.getElementById("day").value;
			} else {
				day = null;
			}
			console.log("Search for:", billNum, day);
			
			if (billNum != "" || day != "") {
				if(dictionary[billNum] == undefined && day == "") {
					alert("Invalid bill, you bitch. Also, fuck you, and have a blessed day");
				} else {
					transitionOut(document.getElementById("firstBox"));
					if (billNum != "") {
						specificBill();
					}
				}
			}	
		}
		
		function boldHTML(x) {
      var element = document.createElement("b");
      element.innerHTML = x;
      return element;
    }


		// Bill
    function fillUpcoming(x) {
		var list = getUpcoming(10);

    var body = document.getElementsByTagName('body')[0];
    var tbl = document.createElement('table');
    tbl.setAttribute('style', 'border-color: #ffffff')
    
    var name = "SB173 - Real Estate BITCH"
    var dateData = '2007-01-01'
    var actionData = 'Read in congress'
    var descStuff = 'Existing law establishes in state government the Business, Consumer Services, and Housing Agency, which is comprised of various departments including the Department of Consumer Affairs. Existing law establishes the Bureau of Real Estate within the Department of Consumer Affairs to license and regulate real estate brokers and real estate salespersons.This bill would remove the bureau from the Department of Consumer Affairs and instead make it a department within the Business, Consumer Services, and Housing Agency and rename the bureau to the Department of Real Estate. The bill would also make other conforming changes.'

    tbl.style.width = '100%';
    tbl.setAttribute('border', '0');
    tbl.setAttribute('style', 'border-collapse: collapse; border-color: #ffffff; width: 100%; text-align: left');
    var tbdy = document.createElement('tbody');
    for(var j = 0; j < 10; j++) {
      //Title
      var title = document.createElement('tr');
      title.setAttribute('style', 'border-color: #ffffff')
      var titleData = document.createElement('td');
      titleData.setAttribute("colSpan", "2");
      title.setAttribute('style', 'border-color: #ffffff; font-size: 20px; font-weight: bold')
      titleData.appendChild(document.createTextNode(list[j]['number'] + ' - ' + list[j]['title']))
      title.appendChild(titleData)
      tbdy.appendChild(title);

      //Date and Action
      var dateAction = document.createElement('tr');
      dateAction.setAttribute('style', 'border-color: #ffffff')
      var date = document.createElement('td');
      date.setAttribute('style', 'border-color: #ffffff; font-size: 15px')
      var action = document.createElement('td');
      action.setAttribute('style', 'border-color: #ffffff; font-size: 15px')
      date.appendChild(boldHTML('Date: '))
      date.appendChild(document.createTextNode(list[j]["date"]))
      action.appendChild(boldHTML('Latest Action: '))
      action.appendChild(document.createTextNode(list[j]['action']))
      dateAction.appendChild(date)
      dateAction.appendChild(action)
      tbdy.appendChild(dateAction);

      //Desc
      var desc = document.createElement('tr');
      desc.setAttribute('style', 'border-color: #ffffff')
      var descData = document.createElement('td');
      descData.setAttribute("colSpan", "2");
      descData.setAttribute("style", "font-size: 15px; padding-bottom: 25px")
      descData.appendChild(boldHTML('Description: '))
      descData.appendChild(document.createTextNode(list[j]['description']))
      desc.appendChild(descData)
      tbdy.appendChild(desc);
  }
    tbl.appendChild(tbdy);
    var el = document.getElementById("list");
    el.appendChild(tbl);

      /*var el = document.getElementById("list");
			el.innerHTML = "";
			for(var i = 0; i<x ; i++) {
				var node = document.createElement("li");
				var link = document.createElement("table");
        link.setAttribute("id", "myTable" + i);
        el.appendChild(link);
				
        var y = document.createElement("TR");
        y.setAttribute("id", "myTr");
        document.getElementById("myTable").appendChild(y);

        var w = document.createElement("TR");
        w.setAttribute("id", "myTr");
        document.getElementById("myTable").appendChild(w);

        var z = document.createElement("TH");
        var t = document.createTextNode("cell");
        z.appendChild(t);
        document.getElementById("myTr").appendChild(z);

        link.innerText = "Hi";
				
				link.setAttribute("onclick", "clickedBill();");
				node.appendChild(link);
				el.appendChild(node);
			}	*/
		}
		
		function clickedBill(x) {
			transitionOut(current);
			var boxTwo = document.getElementById("secondBox");
			current = boxTwo;
			
			//fillBillInfo();
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500);
		}
	
	// Transitions
		function specificBill() {
			var billNum = document.getElementById("bill").value;
			
			console.log(billNum);
			console.log(dictionary[billNum]);
			fillBillInfo(dictionary[billNum]);
			
			var boxTwo = document.getElementById("secondBox");
			current = boxTwo;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500); 
		}
		
		function presentList() {
			var boxThree = document.getElementById("thirdBox");
			current = boxThree;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500); 
		}
		
		function transitionOut(x) {
			x.classList.add("translateOut");
			x.style.opacity="0";
		}
		
		function backToMain() {
			transitionOut(current);
			var firstBox = document.getElementById("firstBox");
			current = firstBox;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
			}, 500); 
			
			document.getElementById("back").style.opacity = 0;
			document.getElementById("back").disabled = true;
		}
	</script>
</html>
