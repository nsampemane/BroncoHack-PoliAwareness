<!DOCTYPE html>

<html>
  <head>
    <title>CalVote</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- cdn for modernizr, if you haven't included it already -->
    <script src="http://cdn.jsdelivr.net/webshim/1.12.4/extras/modernizr-custom.js"></script>
    <!-- polyfiller file to detect and load polyfills -->
    <script src="http://cdn.jsdelivr.net/webshim/1.12.4/polyfiller.js"></script>
    <script>
      webshims.setOptions('waitReady', false);
      webshims.setOptions('forms-ext', {types: 'date'});
      webshims.polyfill('forms forms-ext');
    </script>
  </head>



	<body>
		<!-- Main Screen -->
    <div id="firstBox">
			<form id="centerBox" class="fade-in" action="javascript:void(0);">
				<h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
        <input type="submit" value="Upcoming" onclick="upcoming()" />
        <h3>- OR -</h3>

        <label for="bill">Bill Number</label>
				<input type="text" id="bill" name="firstname" placeholder="Number...">

        <label for="day">Day</label><br>
				<input type="date" id="day" name="day"><br>

				<input type="submit" value="Search" onclick="search()" />
			</form>
		</div>
		

    <!-- Blank Box -->
		<div id="secondBox">
			<h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
			<div id="text">
			</div>
		</div>


		<!-- List Box -->
		<div id="thirdBox">
			<h3><span style="color: #ecbb59">Vote</span><span style="color: #0000B2">CA</span></h3>
			<ol id="list">
			</ol>
		</div>
		

    <input type="submit" id="back" value="Back" onclick="backToMain()" disabled/>
	</body>
	

	<script>
    // Dictionary
    var key = "d09ad1beb3b885847a39492a0f66987d";
    var url = "https://api.legiscan.com/?key=" + key + "&op=";

		var xhr = new XMLHttpRequest();
		xhr.open("GET", url + "getMasterList&id=1400", false);
		xhr.send();
		var test= JSON.parse(xhr.responseText);

		function getDictionary (jsession)
		{
			var dicty= {};
			var ids = [];
			for (var key in jsession.masterlist)
			{	
				if (isNaN(key))
				{
					continue; //skips over non-number at end
				}
				var id = jsession.masterlist[key].bill_id;
				var number = jsession.masterlist[key].number;
				dicty[number] = id;
				ids.push[id];
				//document.write( number+ " : " + dicty[number] + "<br>");
	
			}
			return dicty
		}
		
		var dictionary = getDictionary(test);
		
		
		function getDocNumber(billNumber)
		{
			var xhr = new XMLHttpRequest();
			xhr.open("GET", url + "getBill&id=" + billNumber, false);
			xhr.send();
			var test= JSON.parse(xhr.responseText);
			var docNumber= test.bill.texts[test.bill.texts.length-1].doc_id; //test.bill.texts is an array so gets current version (last item in x)
			
			return docNumber;
		}
		//1439185
		
		function fillBillInfo(x) {
			var xhr = new XMLHttpRequest();
			xhr.open("GET", url + "getBillText&id="+getDocNumber(x), false);
			xhr.send();
			testyj = JSON.parse(xhr.responseText);
			document.getElementById("text").innerHTML = atob(testyj.text.doc);
		}
	
	
	//
		var current =  document.getElementById("firstBox");
		
		function upcoming() {
			transitionOut(current);
			fillUpcoming(10);
			presentList();
		}
	
		function search() {
			var billNum = document.getElementById("bill").value;
			var day;
			if (document.getElementById("day") != null) {
				day = document.getElementById("day").value;
			} else {
				day = null;
			}
			console.log("Search for:", billNum, day);
			
			if (billNum != "" || day != "") {
				if(dictionary[billNum] == undefined) {
					alert("Invalid bill, you bitch. Also, fuck you, and havae a blessed day");
				} else {
					transitionOut(document.getElementById("firstBox"));
					if (billNum != "") {
						specificBill();
					}
				}
			}	
		}
		
		
		// Bill
		function fillUpcoming(x) {
			var el = document.getElementById("list");
			el.innerHTML = "";
			for(var i = 0; i<x ; i++) {
				var node = document.createElement("li");
				var link = document.createElement("a");
				link.innerText = "Hi";
				link.setAttribute("href", "#");
				link.setAttribute("onclick", "clickedBill();");
				node.appendChild(link);
				el.appendChild(node);
			}	
		}
		
		function clickedBill(x) {
			transitionOut(current);
			var boxTwo = document.getElementById("secondBox");
			current = boxTwo;
			
			//fillBillInfo();
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500);
		}
	
	// Transitions
		function specificBill() {
			var billNum = document.getElementById("bill").value;
			
			console.log(billNum);
			console.log(dictionary[billNum]);
			fillBillInfo(dictionary[billNum]);
			
			var boxTwo = document.getElementById("secondBox");
			current = boxTwo;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500); 
		}
		
		function presentList() {
			var boxThree = document.getElementById("thirdBox");
			current = boxThree;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
				document.getElementById("back").style.opacity = 1;
				document.getElementById("back").disabled = false;
			}, 500); 
		}
		
		function transitionOut(x) {
			x.classList.add("translateOut");
			x.style.opacity="0";
		}
		
		function backToMain() {
			transitionOut(current);
			var firstBox = document.getElementById("firstBox");
			current = firstBox;
			setTimeout(function(){
				current.classList.remove("translateOut");
				current.classList.add("fade-in");
			}, 500); 
			
			document.getElementById("back").style.opacity = 0;
			document.getElementById("back").disabled = true;
		}
	</script>
</html>
